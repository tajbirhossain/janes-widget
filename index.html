<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/lightpick@1.6.2/css/lightpick.min.css" rel="stylesheet">
    <title>JH Apartments Buchung</title>
    <style>
        :root {
            --primary-color: #FF385C;
            --secondary-color: #113B7A;
            --text-color: #222222;
            --light-text-color: #717171;
            --border-color: #DDDDDD;
            --background-color: #F7F7F7;
            --card-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            --hover-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Circular', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', sans-serif;
            color: var(--text-color);
            background-color: var(--background-color);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .subheading {
            font-size: 18px;
            color: var(--light-text-color);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        /* @media (min-width: 992px) {
            .main-content {
                grid-template-columns: 2fr 1fr;
            }
        } */

        .apartment-selector {
            background-color: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
        }

        .apartment-selector h2 {
            margin-bottom: 20px;
        }

        .booking-widget {
            background-color: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            /* position: sticky;
            top: 40px; */
        }

        .widget-header {
            margin-bottom: 24px;
        }

        .price-display {
            font-size: 22px;
            font-weight: 600;
        }

        .price-display .currency {
            font-weight: 400;
        }

        .price-display .per-night {
            font-size: 16px;
            font-weight: 400;
            color: var(--light-text-color);
        }

        .star-rating {
            display: flex;
            align-items: center;
            margin-top: 8px;
            font-size: 14px;
            color: var(--light-text-color);
        }

        .star-rating .star {
            color: var(--primary-color);
            margin-right: 4px;
        }

        .booking-form {
            margin-top: 16px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .date-picker-container {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .date-row {
            display: flex;
        }

        .date-input {
            flex: 1;
            padding: 16px;
            position: relative;
        }

        .date-input:first-child {
            border-right: 1px solid var(--border-color);
        }

        .date-label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
            color: var(--text-color);
        }

        .date-input input {
            width: 100%;
            border: none;
            font-size: 14px;
            font-weight: 400;
            color: var(--text-color);
            background: transparent;
            cursor: pointer;
            outline: none;
        }

        .date-input input::placeholder {
            color: var(--light-text-color);
        }

        .select-container {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .select-label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
            padding: 16px 16px 0;
            color: var(--text-color);
        }

        select,
        input[type="number"],
        input[type="text"],
        input[type="email"],
        input[type="tel"] {
            width: 100%;
            padding: 8px 16px 16px;
            font-size: 14px;
            font-weight: 400;
            color: var(--text-color);
            border: none;
            background: transparent;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"] {
            padding: 8px 0 0;
        }



        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23222222' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .personal-info-container {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .total-price {
            font-size: 16px;
            font-weight: 400;
            text-align: right;
            padding: 16px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
        }

        .total-price .total-label {
            font-weight: 600;
        }

        .total-price .price-value {
            font-weight: 600;
            font-size: 18px;
        }

        .book-button {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, #E61E4D, #D70466);
            color: white;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .book-button:hover {
            transform: scale(1.01);
        }

        .book-button:disabled {
            background: #dddddd;
            cursor: not-allowed;
        }

        .price-breakdown {
            margin-top: 20px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            color: var(--text-color);
        }

        /* Date picker customizations */
        .lightpick .is-start-date,
        .lightpick .is-end-date {
            background-color: #222222 !important;
        }

        .is-start-date {
            border-top-left-radius: 50%;
            border-bottom-left-radius: 50%;
        }

        .is-end-date {
            border-top-right-radius: 50%;
            border-bottom-right-radius: 50%;
        }

        .lightpick__day.is-end-date,
        .lightpick__day.is-end-date:hover,
        .lightpick__day.is-start-date,
        .lightpick__day.is-start-date:hover {
            background-image: linear-gradient(#000000, #000000) !important;
        }


        .checkAvailabilityBtn {
            display: block;
            width: fit-content;
            padding: 16px 40px;
            background: linear-gradient(to right, #E61E4D, #D70466);
            color: white;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin: 0 auto;
            margin-bottom: 30px;
        }



        .apartment-card {
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            cursor: pointer;
        }

        .apartment-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-2px);
        }

        .apartment-card.selected {
            border: 2px solid var(--primary-color);
        }

        .apartment-image {
            height: 200px;
            background-color: #ddd;
            background-size: cover;
            background-position: center;
        }

        .apartment-details {
            padding: 16px;
        }

        .apartment-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .apartment-location {
            color: var(--light-text-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .apartment-features {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .feature-tag {
            background-color: var(--background-color);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .apartment-price {
            font-size: 18px;
            font-weight: 600;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .per-night {
            font-size: 14px;
            font-weight: normal;
            color: #666;
        }

        .select-apartment-btn {
            background-color: #FF385C;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .select-apartment-btn:hover {
            background-color: #e9214a;
        }

        .no-apartments {
            padding: 20px;
            text-align: center;
            color: #666;
            background-color: #f9f9f9;
            border-radius: 8px;
        }



        .selected-apartment-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .selected-apartment-location,
        .selected-apartment-dates,
        .selected-apartment-guests,
        .selected-apartment-price {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .selected-apartment-price {
            font-size: 16px;
            color: #333;
            margin: 8px 0;
        }


        .price-breakdown {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #484848;
        }

        .total-price {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            font-size: 18px;
            font-weight: 600;
        }



        .success-message {
            background-color: #D4EDDA;
            color: #155724;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background-color: #F8D7DA;
            color: #721C24;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }


        /* payment confirm modal */
        .select-payment-modal {
            width: 100vw;
            height: 100vh;
            background-color: #00000070;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
        }

        .payment-modal-con {
            background-color: #fff;
            max-width: 700px;
            width: 70vw;
            border-radius: 10px;
            box-shadow: 2px 2px 21px -4px #1c1c1c;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            padding: 150px 20px;
        }

        .payment-modal-con button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border: 1px solid #dddddd;
            border-radius: 8px;
            font-size: 18px;
            padding: 15px;
            margin: 10px;
            box-shadow: 2px 2px 5px -2px #ccc;
            cursor: pointer;
            scale: 1;
            transition: .3s;
            text-align: start;
        }

        .payment-modal-con button:hover {
            scale: 1.05;
        }

        .payment-modal-con button img,
        .payment-modal-con button svg {
            margin-right: 10px;
        }


        /* stripe modal */
        .stripe-modal {
            width: 100vw;
            height: 100vh;
            background-color: #00000070;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
        }

        .stripe-modal-content {
            background-color: #fff;
            max-width: 700px;
            width: 70vw;
            border-radius: 10px;
            box-shadow: 2px 2px 21px -4px #1c1c1c;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            padding: 150px 20px;
        }

        .stripe-modal-content #card-element {
            width: 100%;
            margin-bottom: 20px;
        }

        .stripe-modal-content button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000000;
            color: #ffffff;
            border: 2px solid #000000;
            border-radius: 8px;
            font-size: 18px;
            padding: 15px;
            margin: 10px;
            box-shadow: 2px 2px 5px -2px #ccc;
            cursor: pointer;
            scale: 1;
            transition: .3s;
        }
        .stripe-modal-content button:hover {
            background-color: #ffffff;
            color: #000000;
        }
        .stripe-modal-content #card-element iframe {
            height: 40px !important;
        }

        .stripe-modal-content #card-element iframe form {
            height: 100% !important;
        }
        
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>JH Apartments</h1>
            <div class="subheading">Buchen Sie Ihren traumhaften Aufenthalt</div>
        </header>

        <div class="main-content">
            <div class="apartment-selector">
                <h2>Alle Wohnungen</h2>
                <div id="allApartments"></div>
            </div>
            <div class="booking-widget">
                <div class="widget-header">
                    <h2>Unterkunft Buchung</h2>
                    <div class="info-text">Wählen Sie die Daten und Gästeanzahl, um verfügbare Unterkünfte zu sehen
                    </div>
                </div>

                <div class="booking-form">
                    <div class="success-message" id="successMessage">
                        Buchung erfolgreich! Eine Bestätigung wurde an Ihre E-Mail gesendet.
                    </div>

                    <div class="error-message" id="errorMessage"></div>

                    <div class="date-picker-container">
                        <div class="date-row">
                            <div class="date-input">
                                <label class="date-label">Anreise</label>
                                <input type="text" id="startDate" placeholder="Datum hinzufügen" readonly>
                            </div>
                            <div class="date-input">
                                <label class="date-label">Abreise</label>
                                <input type="text" id="endDate" placeholder="Datum hinzufügen" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="select-container">
                        <label class="select-label">Gäste</label>
                        <input type="number" id="guests" min="1" value="1">
                    </div>

                    <button class="checkAvailabilityBtn" id="checkAvailabilityBtn">Verfügbarkeit prüfen</button>
                </div>
            </div>

            <div class="apartment-selector" id="apartmentSelectorSection" style="display: none;">
                <h2>Verfügbare Unterkünfte</h2>
                <div id="apartmentCards"></div>
            </div>

            <div class="booking-details-section" id="bookingDetailsSection" style="display: none;">
                <div class="selected-apartment-details" id="selectedApartmentDetails"> </div>

                <div id="priceBreakdown" class="price-breakdown">
                    <div class="price-row">
                        <div><span id="nightlyRate">€ --</span> x <span id="nightCount">0</span> Nächte</div>
                        <div id="subtotal">€ --</div>
                    </div>
                </div>

                <div class="personal-info-container">
                    <h3 style="margin-bottom: 16px;">Persönliche Informationen</h3>
                    <div class="input-group">
                        <label class="input-label">Vorname</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Nachname</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">E-Mail</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Telefonnummer</label>
                        <input type="tel" id="phone" required>
                    </div>
                </div>

                <button id="bookingButton" class="book-button">Jetzt buchen</button>
            </div>
        </div>
    </div>
    <div class="select-payment-modal" style="display: none;">
        <div class="payment-modal-con">
            <button data-payment="paypal">
                <img src="https://www.paypalobjects.com/marketing/web/logos/paypal-mark-color.svg" alt=""
                    style="height: 30px;">
                <span>Bezahlen mit Paypal</span>
            </button>
            <button data-payment="stripe">
                <svg viewBox="0 0 60 25" xmlns="http://www.w3.org/2000/svg" width="60" height="30"
                    class="UserLogo variant-- ">
                    <title>Stripe logo</title>
                    <path fill="var(--userLogoColor, #0A2540)"
                        d="M59.64 14.28h-8.06c.19 1.93 1.6 2.55 3.2 2.55 1.64 0 2.96-.37 4.05-.95v3.32a8.33 8.33 0 0 1-4.56 1.1c-4.01 0-6.83-2.5-6.83-7.48 0-4.19 2.39-7.52 6.3-7.52 3.92 0 5.96 3.28 5.96 7.5 0 .4-.04 1.26-.06 1.48zm-5.92-5.62c-1.03 0-2.17.73-2.17 2.58h4.25c0-1.85-1.07-2.58-2.08-2.58zM40.95 20.3c-1.44 0-2.32-.6-2.9-1.04l-.02 4.63-4.12.87V5.57h3.76l.08 1.02a4.7 4.7 0 0 1 3.23-1.29c2.9 0 5.62 2.6 5.62 7.4 0 5.23-2.7 7.6-5.65 7.6zM40 8.95c-.95 0-1.54.34-1.97.81l.02 6.12c.4.44.98.78 1.95.78 1.52 0 2.54-1.65 2.54-3.87 0-2.15-1.04-3.84-2.54-3.84zM28.24 5.57h4.13v14.44h-4.13V5.57zm0-4.7L32.37 0v3.36l-4.13.88V.88zm-4.32 9.35v9.79H19.8V5.57h3.7l.12 1.22c1-1.77 3.07-1.41 3.62-1.22v3.79c-.52-.17-2.29-.43-3.32.86zm-8.55 4.72c0 2.43 2.6 1.68 3.12 1.46v3.36c-.55.3-1.54.54-2.89.54a4.15 4.15 0 0 1-4.27-4.24l.01-13.17 4.02-.86v3.54h3.14V9.1h-3.13v5.85zm-4.91.7c0 2.97-2.31 4.66-5.73 4.66a11.2 11.2 0 0 1-4.46-.93v-3.93c1.38.75 3.1 1.31 4.46 1.31.92 0 1.53-.24 1.53-1C6.26 13.77 0 14.51 0 9.95 0 7.04 2.28 5.3 5.62 5.3c1.36 0 2.72.2 4.09.75v3.88a9.23 9.23 0 0 0-4.1-1.06c-.86 0-1.44.25-1.44.9 0 1.85 6.29.97 6.29 5.88z"
                        fill-rule="evenodd"></path>
                </svg>
                <span>Bezahlen mit Stripe</span>
            </button>
        </div>
    </div>
    <div class="stripe-modal" style="display:none;">
        <div class="stripe-modal-content" style="background:#fff; padding:2rem; border-radius:8px;">
            <div id="card-element"></div>
            <button id="confirm-stripe">Karte bestätigen</button>
        </div>
    </div>
    <div id="result-3"></div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightpick@1.6.2/lightpick.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>

    <!-- https://login.smoobu.com/en/login
    harmsjannes.bnb@gmail.com
    Allthewayup25!
    YSORbwlPHwzAULw0nRcqCFBC96mIujcDzv64378mP1
    UdqeLSQGxw4f5L1lYfClkzN22ctlDKwAh0ne6keBqb -->
    <script>
        const currentLang = document.documentElement.lang.slice(0, 2) || "de";
        const PROXY_URL = "https://jh-apartment-backend-6atm.vercel.app/api/proxy";
        let selectedStartDate = null;
        let selectedEndDate = null;
        let availableDates = new Set();
        let unavailableDates = new Set();
        let startPicker, endPicker;
        let apartmentData = [];
        let selectedApartmentId = null;

        // const stripe = Stripe('pk_test_51ROvxgHQVdZdGspDwG6umJiYm9hHmSZpolUSyTZqQoJx8AOVGDk1G3waqmLqvl86V33kjxqb8azkBZglBmF5Wxq900Ly1J40ot');
        // const elements = stripe.elements();
        // const cardElement = elements.create('card');
        // cardElement.mount('#card-element');


        function initDaterangepicker() {
            var picker = new Lightpick({
                field: document.getElementById('startDate'),
                secondField: document.getElementById('endDate'),
                singleDate: false,
                numberOfMonths: 2,
                minDate: new Date(),
                onSelect: function (start, end) {
                    if (start) {
                        selectedStartDate = start.format('YYYY-MM-DD');
                    }
                    if (end) {
                        selectedEndDate = end.format('YYYY-MM-DD');
                    }
                }
            });
        }


        async function fetchAllApartments() {
            const allApartments = document.querySelector("#allApartments");
            try {
                const response = await fetch(`${PROXY_URL}/apartments`);
                const data = await response.json();
                console.log("All Apartments Data:", data);

                if (data.apartments && Array.isArray(data.apartments)) {
                    apartmentData = data.apartments;
                    allApartments.innerHTML = apartmentData.map(item => {
                        return (
                            `
                    <div class="apartment-card" data-id="${item.id}">
                        <div class="apartment-image" style="background-image: url('')"></div>
                        <div class="apartment-details">
                            <div class="apartment-name">${item.name}</div>
                            <div class="apartment-location">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                ${item.location || 'Location information not available'}
                            </div>
                            <div>Bis zu ${item.maxPersons} Gäste</div>
                            <div class="apartment-features">
                                ${item.bedrooms ? `<span class="feature-tag">${item.bedrooms} Schlafzimmer</span>` : ''}
                                ${item.bathrooms ? `<span class="feature-tag">${item.bathrooms} Badezimmer</span>` : ''}
                                ${item.size ? `<span class="feature-tag">${item.size} m²</span>` : ''}
                            </div>
                        </div>
                    </div>
                    `
                        );
                    }).join("");

                    return apartmentData;
                } else {
                    console.error("No apartments found:", data);
                    showErrorMessage("Keine Unterkünfte verfügbar. Bitte überprüfen Sie die API-Verbindung.");
                    return [];
                }
            } catch (error) {
                console.error("Error fetching apartments:", error);
                showErrorMessage("Fehler beim Abrufen der Unterkünfte: " + error.message);
                return [];
            }
        }

        let selectedApartmentIds = [];

        function setupApartmentSelection() {
            const allApartmentsCards = document.querySelectorAll("#allApartments .apartment-card");
            allApartmentsCards.forEach(item => {
                const cardId = item.dataset.id;

                item.addEventListener("click", () => {
                    if (item.classList.contains("selected")) {
                        selectedApartmentIds = selectedApartmentIds.filter(id => id !== cardId);
                        item.classList.remove("selected");
                    } else {
                        selectedApartmentIds.push(cardId);
                        item.classList.add("selected");
                    }
                    console.log("Selected apartment IDs:", selectedApartmentIds);
                });
            });
        }

        async function checkAvailability() {
            document.getElementById("apartmentCards").innerHTML = '';
            document.getElementById("errorMessage").style.display = "none";
            document.getElementById("bookingDetailsSection").style.display = "none";
            selectedApartmentId = null;

            const guests = parseInt(document.getElementById("guests").value);

            if (!selectedStartDate || !selectedEndDate) {
                showErrorMessage("Bitte wählen Sie Anreise- und Abreisedatum aus.");
                return;
            }

            if (selectedApartmentIds.length === 0) {
                showErrorMessage("Bitte wählen Sie mindestens eine Unterkunft aus.");
                return;
            }

            const startDate = new Date(selectedStartDate);
            const endDate = new Date(selectedEndDate);
            if (endDate <= startDate) {
                showErrorMessage("Das Abreisedatum muss nach dem Anreisedatum liegen.");
                return;
            }

            const checkButton = document.getElementById("checkAvailabilityBtn");
            checkButton.disabled = true;
            checkButton.textContent = "Suche Unterkünfte...";

            try {
                if (apartmentData.length === 0) {
                    await fetchAllApartments();
                }

                const apartmentIds = selectedApartmentIds.map(id => parseInt(id));

                const response = await fetch(`${PROXY_URL}/check-availability`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        arrivalDate: selectedStartDate,
                        departureDate: selectedEndDate,
                        apartments: apartmentIds,
                        guests: guests,
                        customerId: 981908,
                    })
                });

                const data = await response.json();
                console.log("Availability Data:", data);

                document.getElementById("apartmentSelectorSection").style.display = "block";

                if (data.availableApartments && Array.isArray(data.availableApartments) && data.availableApartments.length > 0) {
                    const availableApartmentIds = data.availableApartments.map(id => parseInt(id));
                    const availableApartments = apartmentData.filter(apt =>
                        availableApartmentIds.includes(parseInt(apt.id))
                    );

                    renderApartmentCards(availableApartments, data.prices || {});
                } else {
                    document.getElementById("apartmentCards").innerHTML =
                        '<div class="no-apartments">Keine verfügbaren Unterkünfte für diese Daten gefunden.</div>';
                }
            } catch (error) {
                console.error("Error checking availability:", error);
                showErrorMessage("Fehler bei der Verfügbarkeitsprüfung: " + error.message);
            } finally {
                checkButton.disabled = false;
                checkButton.textContent = "Verfügbarkeit prüfen";
            }
        }


        function renderApartmentCards(apartments, priceData) {
            const apartmentCardsContainer = document.getElementById("apartmentCards");
            apartmentCardsContainer.innerHTML = '';

            if (apartments.length === 0) {
                apartmentCardsContainer.innerHTML =
                    '<div class="no-apartments">Keine verfügbaren Unterkünfte für diese Daten gefunden.</div>';
                return;
            }

            apartments.forEach(apartment => {
                const card = document.createElement("div");
                card.className = "apartment-card";
                card.dataset.id = apartment.id;

                const imageUrl = apartment.picture ? apartment.picture : "/api/placeholder/400/200";


                let priceDisplay = "Preis nicht verfügbar";
                let currencySymbol = "€";
                let priceValue = 0;

                if (priceData[apartment.id]) {

                    const apartmentPrice = priceData[apartment.id];
                    priceValue = apartmentPrice.price;
                    currencySymbol = apartmentPrice.currency || "€";
                    priceDisplay = `${currencySymbol} ${priceValue.toFixed(2)}`;
                } else if (apartment.basePrice) {

                    priceValue = apartment.basePrice;
                    priceDisplay = `${currencySymbol} ${priceValue.toFixed(2)}`;
                }

                card.innerHTML = `
            <div class="apartment-image" style="background-image: url('${imageUrl}')"></div>
            <div class="apartment-details">
                <div class="apartment-name">${apartment.name}</div>
                <div class="apartment-location">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    ${apartment.location || 'Location information not available'}
                </div>
                <div>Bis zu ${apartment.maxPersons} Gäste</div>
                <div class="apartment-features">
                    ${apartment.bedrooms ? `<span class="feature-tag">${apartment.bedrooms} Schlafzimmer</span>` : ''}
                    ${apartment.bathrooms ? `<span class="feature-tag">${apartment.bathrooms} Badezimmer</span>` : ''}
                    ${apartment.size ? `<span class="feature-tag">${apartment.size} m²</span>` : ''}
                </div>
                <div class="apartment-price">${priceDisplay} <span class="per-night">pro Nacht</span></div>
                <button class="select-apartment-btn">Auswählen</button>
            </div>
        `;

                card.querySelector('.select-apartment-btn').addEventListener('click', () => {
                    selectApartment(apartment, priceData[apartment.id]);
                });

                apartmentCardsContainer.appendChild(card);
            });
        }


        function selectApartment(apartment, priceData) {

            selectedApartmentId = apartment.id;


            document.querySelectorAll('#apartmentCards .apartment-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.id == apartment.id) {
                    card.classList.add('selected');
                }
            });


            const bookingSection = document.getElementById("bookingDetailsSection");
            bookingSection.style.display = "block";


            bookingSection.scrollIntoView({ behavior: 'smooth' });


            const detailsContainer = document.getElementById("selectedApartmentDetails");
            const imageUrl = apartment.picture ? apartment.picture : "/api/placeholder/400/200";


            const formattedStartDate = formatDate(selectedStartDate);
            const formattedEndDate = formatDate(selectedEndDate);


            let priceDisplay = "Preis nicht verfügbar";
            let currencySymbol = "€";

            if (priceData) {
                const priceValue = priceData.price;
                currencySymbol = priceData.currency || "€";
                priceDisplay = `${currencySymbol} ${priceValue.toFixed(2)}`;
            } else if (apartment.basePrice) {
                const priceValue = apartment.basePrice;
                priceDisplay = `${currencySymbol} ${priceValue.toFixed(2)}`;
            }

            detailsContainer.innerHTML = `
        <div class="selected-apartment-header">
            <h3>Ausgewählte Unterkunft</h3>
        </div>
        <div class="selected-apartment-content">
            <div class="selected-apartment-image" style="background-image: url('${imageUrl}')"></div>
            <div class="selected-apartment-info">
                <div class="selected-apartment-name">${apartment.name}</div>
                <div class="selected-apartment-location">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    ${apartment.location || 'Location information not available'}
                </div>
                <div class="selected-apartment-price">
                    <strong>${priceDisplay}</strong> <span class="per-night">pro Nacht</span>
                </div>
                <div class="selected-apartment-dates">
                    ${formattedStartDate} bis ${formattedEndDate}
                </div>
                <div class="selected-apartment-guests">
                    ${document.getElementById("guests").value} Gäste
                </div>
            </div>
        </div>
    `;


            calculatePriceBreakdown(apartment, priceData);
        }


        function formatDate(dateStr) {
            if (!dateStr) return '';

            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();

            return `${day}.${month}.${year}`;
        }


        function calculatePriceBreakdown(apartment, priceData) {
            const start = new Date(selectedStartDate);
            const end = new Date(selectedEndDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));


            document.getElementById("nightCount").textContent = diffDays;

            let nightlyRate = 0;
            let totalPrice = 0;
            let currencySymbol = "€";
            let basePriceItem = null;


            if (priceData) {

                currencySymbol = priceData.currency || "€";
                totalPrice = priceData.price;


                if (priceData.priceElements && Array.isArray(priceData.priceElements)) {
                    basePriceItem = priceData.priceElements.find(item => item.type === "basePrice");
                    if (basePriceItem) {
                        nightlyRate = basePriceItem.amount;
                    } else {

                        nightlyRate = totalPrice / diffDays;
                    }
                } else {

                    nightlyRate = totalPrice / diffDays;
                }
            } else if (apartment.basePrice) {

                nightlyRate = apartment.basePrice;
                totalPrice = nightlyRate * diffDays;
            }


            document.getElementById("nightlyRate").textContent = `${currencySymbol} ${nightlyRate.toFixed(2)}`;


            const subtotal = nightlyRate * diffDays;
            document.getElementById("subtotal").textContent = `${currencySymbol} ${subtotal.toFixed(2)}`;


            // const serviceFee = subtotal * 0.12;
            // document.getElementById("serviceFee").textContent = `${currencySymbol} ${serviceFee.toFixed(2)}`;


            // const cleaningFee = 35;
            // document.getElementById("cleaningFee").textContent = `${currencySymbol} ${cleaningFee.toFixed(2)}`;


            // const calculatedTotal = subtotal + serviceFee + cleaningFee;
            // document.getElementById("totalPrice").textContent = `${currencySymbol} ${calculatedTotal.toFixed(2)}`;
        }

        // Submit booking
        async function submitBooking() {

            const firstName = document.getElementById("firstName").value;
            const lastName = document.getElementById("lastName").value;
            const email = document.getElementById("email").value;
            const phone = document.getElementById("phone").value;
            const guests = parseInt(document.getElementById("guests").value);

            if (!selectedApartmentId || !selectedStartDate || !selectedEndDate ||
                !firstName || !lastName || !email || !phone) {
                showErrorMessage("Bitte füllen Sie alle Felder aus.");
                return;
            }


            const bookButton = document.getElementById("bookingButton");
            bookButton.disabled = true;
            bookButton.textContent = "Buchung wird verarbeitet...";


            document.getElementById("errorMessage").style.display = "none";
            document.getElementById("successMessage").style.display = "none";


            const bookingPayload = {
                arrivalDate: selectedStartDate,
                departureDate: selectedEndDate,
                channelId: 70,
                apartmentId: parseInt(selectedApartmentId),
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phone,
                adults: guests,
                children: 0
            };

            console.log(bookingPayload);

            try {
                const method = await showPaymentSelector();

                const { clientSecret, paymentId, approvalUrl } =
                    await initiatePayment(bookingPayload, method);

                if (method === 'paypal') {
                    if (!approvalUrl) throw new Error('Approval URL fehlt');
                    window.location.href = approvalUrl;
                    return;
                }

                await showStripeModal(clientSecret, paymentId);

                const confirmRes = await fetch(`${PROXY_URL}/finalize-booking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentId, method })
                });
                const confirmData = await confirmRes.json();
                if (!confirmData.success) throw new Error(confirmData.error || 'Unbekannter Fehler');

            } catch (err) {
                showErrorMessage("Fehler: " + err.message);
            } finally {
                bookButton.disabled = false;
                bookButton.textContent = "Jetzt buchen";
            }

            // try {
            //     const response = await fetch(`${PROXY_URL}/reservations`, {
            //         method: "POST",
            //         headers: {
            //             "Content-Type": "application/json"
            //         },
            //         body: JSON.stringify(bookingPayload)
            //     });

            //     const data = await response.json();
            //     console.log("Booking Response:", data);

            //     if (data.id) {

            //         document.getElementById("successMessage").style.display = "block";


            //         resetForm();


            //         window.scrollTo({ top: 0, behavior: 'smooth' });
            //     } else {
            //         showErrorMessage("Fehler bei der Buchung: " + (data.message || JSON.stringify(data)));
            //     }
            // } catch (error) {
            //     console.error("Error submitting booking:", error);
            //     showErrorMessage("Fehler beim Absenden der Buchung: " + error.message);
            // } finally {

            //     bookButton.disabled = false;
            //     bookButton.textContent = "Jetzt buchen";
            // }
        }

        async function initiatePayment(bookingPayload, method /* "stripe"|"paypal" */) {
            const res = await fetch(`${PROXY_URL}/initiate-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...bookingPayload, method })
            });
            return res.json(); // { clientSecret, paymentId, approvalUrl, ... }
        }

        async function showStripeModal(clientSecret, paymentId) {
            return new Promise((resolve, reject) => {
                const stripe = Stripe('pk_test_51ROvxgHQVdZdGspDwG6umJiYm9hHmSZpolUSyTZqQoJx8AOVGDk1G3waqmLqvl86V33kjxqb8azkBZglBmF5Wxq900Ly1J40ot');
                const elements = stripe.elements();
                const cardEl = elements.create('card');
                cardEl.mount('#card-element');

                const modal = document.querySelector('.stripe-modal');
                modal.style.display = 'flex';

                document.getElementById('confirm-stripe').addEventListener('click', async () => {
                    const { error } = await stripe.confirmCardPayment(clientSecret, {
                        payment_method: { card: cardEl }
                    });
                    if (error) {
                        reject(error);
                        return;
                    }
                    modal.style.display = 'none';
                    cardEl.unmount();
                    resolve();
                }, { once: true });
            });
        }

        function showPaymentSelector() {
            return new Promise(resolve => {
                const modal = document.querySelector('.select-payment-modal');
                modal.style.display = 'flex';
                modal.addEventListener('click', function handler(e) {
                    const paymentType = e.target.closest('button')?.dataset?.payment;
                    if (!paymentType) return;
                    modal.style.display = 'none';
                    modal.removeEventListener('click', handler);
                    resolve(paymentType);
                });
            });
        }
        // function showPaymentSelector() {
        //     return new Promise(resolve => {
        //         const modal = document.querySelector('.select-payment-modal');
        //         modal.style.display = 'flex';

        //         function handleClick(e) {
        //             const paymentType = e.target.closest('button')?.dataset?.payment;
        //             if (paymentType) {
        //                 modal.style.display = 'none';
        //                 modal.removeEventListener('click', handleClick);
        //                 resolve(paymentType);
        //             }
        //         }

        //         modal.addEventListener('click', handleClick);
        //     });
        // }


        function resetForm() {

            selectedStartDate = null;
            selectedEndDate = null;
            if (startPicker && endPicker) {
                startPicker.clear();
                endPicker.clear();
            }


            document.getElementById("guests").value = "1";
            document.getElementById("firstName").value = "";
            document.getElementById("lastName").value = "";
            document.getElementById("email").value = "";
            document.getElementById("phone").value = "";


            document.getElementById("apartmentSelectorSection").style.display = "none";
            document.getElementById("bookingDetailsSection").style.display = "none";


            selectedApartmentId = null;
        }


        function showErrorMessage(message) {
            const errorElement = document.getElementById("errorMessage");
            errorElement.textContent = message;
            errorElement.style.display = "block";
            // window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        function init() {
            initDaterangepicker();

            document.getElementById("checkAvailabilityBtn").addEventListener("click", checkAvailability);
            document.getElementById("bookingButton").addEventListener("click", submitBooking);

            document.getElementById("apartmentSelectorSection").style.display = "none";
            document.getElementById("bookingDetailsSection").style.display = "none";

            fetchAllApartments().then(() => {
                setupApartmentSelection();
            });
        }


        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>